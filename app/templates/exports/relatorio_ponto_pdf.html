<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>{{ titulo }}</title> {# O título da janela não aparecerá no PDF final #}
    {# Estilos CSS serão injetados aqui pela função create_pdf #}
</head>
<body>
    {# 1. Cabeçalho Oficial #}
    <div class="cabecalho-oficial">
        <p>RELATÓRIO DE PRODUTIVIDADE MENSAL</p>
        <p>Diretoria de Políticas Penais – DIRPP</p>
        <p>Secretaria Nacional de Políticas Penais – SENAPPEN</p>
        <p>Ministério da Justiça e Segurança Pública</p>
        <p class="periodo">Período: {{ nome_mes }} / {{ ano_atual }}</p>
    </div>

    {# 2. Identificação do Servidor #}
    <div class="card identificacao-section">
        <div class="card-header">
            <h2>IDENTIFICAÇÃO DO SERVIDOR(A)/COLABORADOR (A) EVENTUAL</h2>
        </div>
        <div class="card-body">
            {% if usuario %}
            <table>
                <tr><td class="label">Nome:</td><td>{{ usuario.name }}</td></tr>
                <tr><td class="label">Matrícula:</td><td>{{ usuario.matricula }}</td></tr>
                <tr><td class="label">Cargo:</td><td>{{ usuario.cargo or 'N/A' }}</td></tr>
                <tr><td class="label">Vínculo:</td><td>{{ usuario.vinculo or 'N/A' }}</td></tr>
                <tr><td class="label">Unidade/Setor:</td><td>{{ usuario.unidade_setor or 'N/A' }}</td></tr>
                <tr><td class="label">Chefia Imediata:</td><td>{{ usuario.chefia_imediata or 'N/A' }}</td></tr>
                <tr><td class="label">UF:</td><td>{{ usuario.uf or 'N/A' }}</td></tr>
                <tr><td class="label">Telefone:</td><td>{{ usuario.telefone or 'N/A' }}</td></tr>
                <tr><td class="label">Email:</td><td>{{ usuario.email }}</td></tr>
            </table>
            {% else %}
            <p>Informações do usuário indisponíveis.</p>
            {% endif %}
        </div>
    </div>

    {# Resumo do Mês (Opcional, pode ser removido se não desejado) #}
    <div class="card resumo-section">
        <div class="card-header">
            <h2>RESUMO DO MÊS</h2>
        </div>
        <div class="card-body">
             <table>
                 <thead>
                    <tr>
                        <th>Dias Úteis</th>
                        <th>Dias Trabalhados</th>
                        <th>Dias de Afastamento</th>
                        <th>Horas Trabalhadas</th>
                        <th>Carga Horária Devida</th>
                        <th>Saldo de Horas</th>
                    </tr>
                 </thead>
                 <tbody>
                    <tr>
                        <td class="text-center">{{ dias_uteis }}</td>
                        <td class="text-center">{{ dias_trabalhados }}</td>
                        <td class="text-center">{{ dias_afastamento }}</td>
                        <td class="text-center">{{ "%.2f"|format(horas_trabalhadas) }}h</td>
                        <td class="text-center">{{ "%.2f"|format(carga_horaria_devida) }}h</td>
                        <td class="text-center saldo-horas {% if saldo_horas < 0 %}saldo-negativo{% endif %}">
                           {{ "%+.2f"|format(saldo_horas) }}h
                        </td>
                    </tr>
                 </tbody>
            </table>
        </div>
    </div>

    {# 3. Registros Detalhados do Mês #}
    <div class="card registros-section">
        <div class="card-header">
            <h2>REGISTROS MENSAIS</h2>
        </div>
        <div class="card-body">
            <table>
                <thead>
                    <tr>
                        <th class="col-data">Data</th>
                        <th class="col-dia">Dia</th>
                        <th class="col-hora">Entrada</th>
                        <th class="col-hora">Saída Almoço</th>
                        <th class="col-hora">Retorno Almoço</th>
                        <th class="col-hora">Saída</th>
                        <th class="col-hora">Horas Trab.</th>
                        <th class="col-status">Status</th>
                        <th class="col-detalhes">Atividades / Resultados / Observações</th>
                    </tr>
                </thead>
                <tbody>
                    {% set dias_semana = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'] %}
                    {% for dia_num in range(1, ultimo_dia.day + 1) %}
                        {% set data_atual = date_obj(ano_atual, mes_atual, dia_num) %}
                        {% set dia_semana_idx = data_atual.weekday() %}
                        {% set registro = registros_por_data.get(data_atual) %}
                        {% set is_feriado = data_atual in feriados_datas %}
                        {% set is_fim_semana = dia_semana_idx >= 5 %}
                        {% set lista_atividades = atividades_por_ponto.get(registro.id, []) if registro else [] %}

                        {# Só exibe linha se for dia útil, feriado ou tiver registro #}
                        {% if registro or (not is_fim_semana) %}
                            <tr>
                                <td class="col-data">{{ data_atual.strftime('%d/%m/%Y') }}</td>
                                <td class="col-dia">{{ dias_semana[dia_semana_idx] }}</td>

                                {% if is_feriado %}
                                    <td colspan="6" class="text-center status-feriado">{{ feriados_dict[data_atual] }}</td>
                                    <td class="col-status text-center status-feriado">Feriado</td>
                                    <td class="col-detalhes">-</td>
                                {% elif is_fim_semana and not registro %}
                                    {# Opcional: Ocultar FDS sem registro ou mostrar como FDS #}
                                    {# <td colspan="6" class="text-center status-fds">Fim de Semana</td>
                                    <td class="col-status text-center status-fds">FDS</td>
                                    <td class="col-detalhes">-</td> #}
                                {% elif registro %}
                                    {% if registro.afastamento %}
                                        <td colspan="6" class="text-center status-afastamento">{{ registro.tipo_afastamento|default('Afastamento', true)|capitalize }}</td>
                                        <td class="col-status text-center status-afastamento">Afast.</td>
                                        <td class="col-detalhes">{{ registro.observacoes or '-' }}</td>
                                    {% else %} {# Dia trabalhado #}
                                        <td class="col-hora text-center">{{ registro.entrada.strftime('%H:%M') if registro.entrada else '-' }}</td>
                                        <td class="col-hora text-center">{{ registro.saida_almoco.strftime('%H:%M') if registro.saida_almoco else '-' }}</td>
                                        <td class="col-hora text-center">{{ registro.retorno_almoco.strftime('%H:%M') if registro.retorno_almoco else '-' }}</td>
                                        <td class="col-hora text-center">{{ registro.saida.strftime('%H:%M') if registro.saida else '-' }}</td>
                                        <td class="col-hora text-center">
                                            {% if registro.horas_trabalhadas is not none %}{{ "%.2f"|format(registro.horas_trabalhadas) }}h{% else %} - {% endif %}
                                        </td>
                                        <td class="col-status text-center">
                                            {% if registro.horas_trabalhadas is not none and registro.horas_trabalhadas >= 8 %}OK
                                            {% elif registro.horas_trabalhadas is not none %}Parcial
                                            {% else %}Pendente
                                            {% endif %}
                                        </td>
                                        <td class="col-detalhes">
                                            {% if lista_atividades %}<strong>Atividades:</strong> {{ lista_atividades|join('; ') }}<br>{% endif %}
                                            {% if registro.resultados_produtos %}<strong>Resultados/Produtos:</strong> {{ registro.resultados_produtos }}<br>{% endif %}
                                            {% if registro.observacoes %}<strong>Observações:</strong> {{ registro.observacoes }}{% endif %}
                                            {% if not lista_atividades and not registro.resultados_produtos and not registro.observacoes %}-{% endif %}
                                        </td>
                                    {% endif %}
                                {% else %} {# Dia útil sem registro #}
                                    <td colspan="6" class="text-center status-pendente">Sem Registro</td>
                                    <td class="col-status text-center status-pendente">Pendente</td>
                                    <td class="col-detalhes">-</td>
                                {% endif %}
                            </tr>
                        {% endif %} {# Fim do if para exibir linha #}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {# 4. Autoavaliação e Declaração #}
    {% if autoavaliacao_data is defined %} {# Verifica se veio do contexto completo #}
    <div class="card autoavaliacao-section">
        <div class="card-header"><h2>AUTOAVALIAÇÃO DO SERVIDOR(A)/COLABORADOR</h2></div>
        <div class="card-body"><p>{{ autoavaliacao_data }}</p></div>
    </div>
    {% endif %}

    {% if dificuldades_data is defined %}
    <div class="card autoavaliacao-section">
        <div class="card-header"><h2>DIFICULDADES OU NECESSIDADES OBSERVADAS</h2></div>
        <div class="card-body"><p>{{ dificuldades_data }}</p></div>
    </div>
    {% endif %}

    {% if sugestoes_data is defined %}
    <div class="card autoavaliacao-section">
        <div class="card-header"><h2>SUGESTÕES DE MELHORIA</h2></div>
        <div class="card-body"><p>{{ sugestoes_data }}</p></div>
    </div>
    {% endif %}

    {% if declaracao_marcada is defined %}
    <div class="card declaracao-box">
         <div class="card-header"><h2>DECLARAÇÃO</h2></div>
         <div class="card-body">
             <p><span class="checkbox-simulado">{% if declaracao_marcada %}&#x2714;{% else %}&#x2717;{% endif %}</span> Declaro que as informações acima refletem, com veracidade, as atividades desempenhadas por mim durante o período informado.</p>
             <p class="assinatura">_________________________________________________________</p>
             <p class="assinatura-nome">{{ usuario.name if usuario else 'Nome Indisponível' }}</p>
             <p class="data-assinatura">Data: {{ data_geracao }}</p>
         </div>
    </div>
    {% endif %}

    {# Rodapé (Opcional, pode ser configurado no @page) #}
    {#
    <div class="footer">
        <p>Sistema de Ponto Eletrônico - SENAPPEN</p>
        <p>Gerado em: {{ data_geracao }}</p>
    </div>
    #}
</body>
</html>
```

**2. Atualização dos Estilos CSS (`app/utils/export.py`)**

Modifique a string `pdf_styles` dentro da função `create_pdf`:


```python
# -*- coding: utf-8 -*-
import os
from datetime import datetime, date
from flask import render_template, current_app
from xhtml2pdf import pisa
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from io import BytesIO
from app.models.ponto import Ponto, Atividade
from app.models.feriado import Feriado
from app.models.user import User
from calendar import monthrange
# Importa a função auxiliar refatorada do controlador
from app.controllers.main import _get_relatorio_mensal_data
import logging # Adicionado para logging

logger = logging.getLogger(__name__) # Configura logger

# Função create_pdf (ATUALIZADA COM NOVOS ESTILOS)
def create_pdf(template_name, output_path, **context):
    """Cria um arquivo PDF a partir de um template HTML."""
    try:
        html_content = render_template(template_name, **context)

        # --- ESTILOS CSS ATUALIZADOS ---
        pdf_styles = """
        <style>
            @page {
                size: A4 portrait; /* Define tamanho A4 e orientação retrato */
                margin: 1.5cm 1.5cm 2cm 1.5cm; /* Margens (top, right, bottom, left) - Aumentada inferior para rodapé */

                /* Opcional: Adicionar rodapé diretamente com CSS Paged Media */
                @bottom-center {
                    content: "Página " counter(page) " de " counter(pages);
                    font-size: 8pt;
                    color: #6c757d;
                }
                 @bottom-left {
                    content: "Sistema de Ponto Eletrônico - SENAPPEN";
                    font-size: 8pt;
                    color: #6c757d;
                 }

            }
            body {
                font-family: Arial, sans-serif; /* Fonte padrão */
                color: #333; /* Cor de texto principal */
                font-size: 10pt; /* Tamanho de fonte base */
                line-height: 1.4;
            }

            /* 1. Cabeçalho Oficial */
            .cabecalho-oficial {
                text-align: center;
                margin-bottom: 25px; /* Aumenta espaço após cabeçalho */
                border-bottom: 1px solid #ccc; /* Linha separadora sutil */
                padding-bottom: 10px;
            }
            .cabecalho-oficial p {
                margin: 2px 0;
                font-size: 10pt;
                color: #444; /* Cor mais escura que cinza padrão */
            }
            .cabecalho-oficial p:first-child { /* Título Principal */
                font-size: 12pt;
                font-weight: bold;
                color: #000;
                margin-bottom: 5px;
            }
             .cabecalho-oficial .periodo {
                font-weight: bold;
                margin-top: 8px;
            }

            /* Estilos gerais para Cards (seções) */
            .card {
                border: 1px solid #ccc; /* Borda mais sutil */
                border-radius: 0; /* Sem bordas arredondadas para visual oficial */
                margin-bottom: 15px;
                background-color: #fff;
                page-break-inside: avoid; /* Tenta evitar quebrar o card entre páginas */
            }
            .card-header {
                background-color: #e9ecef; /* Cinza claro neutro */
                color: #212529; /* Preto suave */
                padding: 6px 10px; /* Padding menor */
                border-bottom: 1px solid #ccc;
                font-weight: bold;
            }
            .card-header h2 {
                font-size: 11pt;
                margin: 0;
            }
            .card-body {
                padding: 10px;
            }
            .card-body p {
                margin-bottom: 6px;
            }

            /* 2. Seção de Identificação */
            .identificacao-section table {
                width: 100%;
                border-collapse: collapse;
                margin: 0; /* Remove margem padrão da tabela */
            }
            .identificacao-section td {
                padding: 3px 5px;
                border: none; /* Sem bordas internas na tabela de identificação */
                font-size: 9pt; /* Fonte ligeiramente menor */
            }
            .identificacao-section td.label {
                font-weight: bold;
                width: 150px; /* Largura fixa para os rótulos */
                color: #555;
            }

            /* 3. Resumo e Registros (Tabelas) */
            table { /* Estilo geral para tabelas de dados */
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
                font-size: 9pt; /* Fonte menor para tabelas */
            }
            th, td {
                border: 1px solid #ccc; /* Bordas sutis */
                padding: 4px 6px; /* Padding ajustado */
                text-align: left;
                vertical-align: top;
            }
            th {
                background-color: #f2f2f2; /* Cinza muito claro para cabeçalhos */
                color: #333;
                font-weight: bold;
                text-align: center;
            }
            tr:nth-child(even) {
                 background-color: #f9f9f9; /* Fundo alternado muito sutil */
            }

            /* Ajustes específicos para tabela de registros */
            .registros-section th.col-data, .registros-section td.col-data { width: 70px; text-align: center; }
            .registros-section th.col-dia, .registros-section td.col-dia { width: 35px; text-align: center; }
            .registros-section th.col-hora, .registros-section td.col-hora { width: 55px; text-align: center; }
            .registros-section th.col-status, .registros-section td.col-status { width: 60px; text-align: center; }
            .registros-section th.col-detalhes, .registros-section td.col-detalhes {
                text-align: left;
                white-space: normal; /* Permite quebra de linha */
                word-wrap: break-word; /* Quebra palavras longas */
            }
             .registros-section td.col-detalhes strong {
                font-weight: bold;
                color: #555;
             }

            /* Estilos de Status (cores neutras) */
            .status-feriado { background-color: #eeeeee; color: #555; font-style: italic; }
            .status-fds { background-color: #f5f5f5; color: #777; font-style: italic; }
            .status-afastamento { background-color: #e0e0e0; color: #444; font-style: italic; }
            .status-pendente { background-color: #f5f5f5; color: #888; font-style: italic; }
            /* Saldo de horas */
            .saldo-horas { font-weight: bold; }
            .saldo-negativo { color: #c00; } /* Vermelho escuro sutil */


            /* 4. Seção de Autoavaliação */
            .autoavaliacao-section .card-header h2 { font-size: 10pt; }
            .autoavaliacao-section .card-body p {
                margin-left: 0; /* Remove indentação anterior */
                text-align: justify;
            }
            .declaracao-box {
                border: 1px solid #ccc;
                padding: 10px;
                margin-top: 15px;
                background-color: #f8f8f8;
            }
             .declaracao-box .card-header h2 { font-size: 10pt; }
             .declaracao-box .card-body p { margin-bottom: 10px; }
            .checkbox-simulado {
                 font-family: ZapfDingbats, sans-serif;
                 font-size: 11pt;
                 margin-right: 5px;
            }
            .assinatura {
                margin-top: 30px;
                text-align: center;
                color: #555;
                font-size: 9pt;
            }
            .assinatura-nome {
                text-align: center;
                font-weight: bold;
                margin-top: 5px;
                margin-bottom: 5px;
                 font-size: 10pt;
            }
            .data-assinatura {
                text-align: center;
                color: #555;
                 font-size: 9pt;
                 margin-bottom: 0;
            }

            /* Utilitários */
            .text-center { text-align: center; }
            .text-muted { color: #6c757d; }
            .fw-bold { font-weight: bold; }
            .fst-italic { font-style: italic; }
            .small { font-size: 9pt; } /* Ajustado para PDF */

        </style>
        """
        # --- FIM DOS ESTILOS CSS ATUALIZADOS ---

        html_content = html_content.replace('</head>', f'{pdf_styles}</head>')
        os.makedirs(os.path.dirname(output_path), exist_ok=True)
        with open(output_path, "wb") as output_file:
            pisa_status = pisa.CreatePDF(html_content, dest=output_file)

        if pisa_status.err:
             logger.error(f"Erro do pisa ao gerar PDF: {pisa_status.err}")
             logger.error(f"Log do pisa: {pisa_status.log}")
             # Tentar logar o HTML que causou o erro (cuidado com dados sensíveis)
             # logger.debug(f"HTML com erro:\n{html_content[:2000]}...") # Loga parte do HTML
             return False
        else:
             logger.info(f"PDF gerado com sucesso em: {output_path}")
             return True

    except Exception as e:
        current_app.logger.error(f"Erro na função create_pdf: {e}", exc_info=True)
        return False

# Função create_excel (mantida)
def create_excel(data, headers, output_path):
    """Cria um arquivo Excel a partir de uma lista de dicionários."""
    try:
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "Dados" # Nome da planilha

        # Estilos (mantidos)
        header_font = Font(bold=True)
        header_fill = PatternFill(start_color="DDDDDD", end_color="DDDDDD", fill_type="solid") # Cinza claro
        header_alignment = Alignment(horizontal="center", vertical="center")
        thin_border = Border(left=Side(style="thin"), right=Side(style="thin"), top=Side(style="thin"), bottom=Side(style="thin"))

        # Escreve o cabeçalho
        for col_idx, header_text in enumerate(headers.values(), 1):
            cell = ws.cell(row=1, column=col_idx, value=header_text)
            cell.font = header_font
            cell.fill = header_fill
            cell.alignment = header_alignment
            cell.border = thin_border

        # Escreve os dados
        for row_idx, row_data in enumerate(data, 2):
            for col_idx, key in enumerate(headers.keys(), 1):
                cell = ws.cell(row=row_idx, column=col_idx, value=row_data.get(key, "")) # Usa .get para evitar erro se chave não existir
                cell.border = thin_border # Aplica borda a todas as células de dados

        # Ajusta largura das colunas (mantido)
        for col_idx in range(1, len(headers) + 1):
            ws.column_dimensions[openpyxl.utils.get_column_letter(col_idx)].width = 15 # Largura padrão

        # Salva o arquivo
        os.makedirs(os.path.dirname(output_path), exist_ok=True)
        wb.save(output_path)
        logger.info(f"Excel gerado com sucesso em: {output_path}")
        return True
    except Exception as e:
        current_app.logger.error(f"Erro ao criar Excel: {e}", exc_info=True)
        return False

# Função calcular_estatisticas_mes (mantida, mas pode ser removida se _get_relatorio_mensal_data for usada sempre)
def calcular_estatisticas_mes(user_id, mes, ano):
    # ... (código mantido) ...
    pass # Implementação omitida por brevidade, assumindo que _get_relatorio_mensal_data é usada

# Função generate_pdf (ATUALIZADA para usar a função auxiliar)
def generate_pdf(user_id, mes, ano, context_completo=None):
    """
    Gera um arquivo PDF com o relatório mensal de ponto.
    Aceita um contexto completo opcional para incluir dados de autoavaliação.
    """
    try:
        context = {}
        # Busca os dados base SEMPRE, pois são necessários para ambos os tipos de relatório
        dados_base = _get_relatorio_mensal_data(user_id, mes, ano)
        usuario = dados_base['usuario'] # Pega o usuário dos dados base

        if context_completo:
            # Se um contexto completo foi fornecido (para exportação do relatório salvo)
            # Apenas garante que os dados base estejam presentes (já estão em dados_base)
            context = {**dados_base, **context_completo} # Combina, garantindo dados base
            # Atualiza o título se necessário (pode já vir no context_completo)
            context['titulo'] = context.get('titulo', f'Relatório de Ponto e Autoavaliação - {dados_base["nome_mes"]}/{ano}')
        else:
            # Monta o contexto padrão (para PDF Padrão)
            context = {
                **dados_base, # Desempacota todos os dados base
                'data_geracao': datetime.now().strftime('%d/%m/%Y %H:%M:%S'),
                'titulo': f'Relatório de Ponto - {dados_base["nome_mes"]}/{ano}'
                # Não inclui chaves de autoavaliação aqui
            }

        # Define o caminho do arquivo de saída
        static_dir = os.path.join(current_app.root_path, 'static')
        exports_dir = os.path.join(static_dir, 'exports')
        os.makedirs(exports_dir, exist_ok=True)
        # Adiciona sufixo '_completo' se for o relatório com autoavaliação
        filename_suffix = '_completo' if context_completo else ''
        filename = f"relatorio{filename_suffix}_{usuario.matricula}_{mes}_{ano}_{datetime.now().strftime('%Y%m%d%H%M%S')}.pdf"
        output_path = os.path.join(exports_dir, filename)

        # Cria o PDF usando o contexto montado
        success = create_pdf('exports/relatorio_ponto_pdf.html', output_path, **context)

        if success:
            return f"exports/{filename}" # Retorna caminho relativo
        else:
            raise Exception("Falha ao gerar PDF via create_pdf")
    except Exception as e:
        current_app.logger.error(f"Erro ao gerar PDF para user {user_id}, {mes}/{ano}: {e}", exc_info=True)
        return None

# Função generate_excel (ATUALIZADA para incluir atividades, resultados, obs)
def generate_excel(user_id, mes, ano):
    """Gera um arquivo Excel com o relatório mensal de ponto."""
    try:
        usuario = User.query.get(user_id)
        if not usuario: raise ValueError(f"Usuário ID {user_id} não encontrado")

        # Usa a função auxiliar para buscar dados consistentes
        dados_relatorio = _get_relatorio_mensal_data(user_id, mes, ano, order_desc=False)

        # Define os cabeçalhos do Excel
        headers = {
            'data': 'Data',
            'dia_semana': 'Dia da Semana',
            'entrada': 'Entrada',
            'saida_almoco': 'Saída Almoço',
            'retorno_almoco': 'Retorno Almoço',
            'saida': 'Saída',
            'horas_trabalhadas': 'Horas Trabalhadas',
            'status': 'Status', # Adicionado Status
            'observacoes': 'Observações',
            'resultados_produtos': 'Resultados/Produtos',
            'atividades': 'Atividades'
        }
        dias_semana_map = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom']
        data_excel = []

        # Itera sobre os dias do mês para incluir dias sem registro também
        for dia_num in range(1, dados_relatorio['ultimo_dia'].day + 1):
            data_atual = date(ano, mes, dia_num)
            dia_semana_idx = data_atual.weekday()
            registro = dados_relatorio['registros_por_data'].get(data_atual)
            is_feriado = data_atual in dados_relatorio['feriados_datas']
            is_fim_semana = dia_semana_idx >= 5

            row = {
                'data': data_atual.strftime('%d/%m/%Y'),
                'dia_semana': dias_semana_map[dia_semana_idx],
                'entrada': '', 'saida_almoco': '', 'retorno_almoco': '', 'saida': '',
                'horas_trabalhadas': '', 'status': '', 'observacoes': '',
                'resultados_produtos': '', 'atividades': ''
            }

            if is_feriado:
                row['status'] = f"Feriado ({dados_relatorio['feriados_dict'][data_atual]})"
            elif is_fim_semana and not registro:
                 row['status'] = "Fim de Semana" # Ou pode omitir
            elif registro:
                if registro.afastamento:
                    row['status'] = f"Afastamento ({registro.tipo_afastamento or 'N/A'})"
                    row['observacoes'] = registro.observacoes or ''
                    row['resultados_produtos'] = registro.resultados_produtos or ''
                else:
                    row['entrada'] = registro.entrada.strftime('%H:%M') if registro.entrada else ''
                    row['saida_almoco'] = registro.saida_almoco.strftime('%H:%M') if registro.saida_almoco else ''
                    row['retorno_almoco'] = registro.retorno_almoco.strftime('%H:%M') if registro.retorno_almoco else ''
                    row['saida'] = registro.saida.strftime('%H:%M') if registro.saida else ''
                    row['horas_trabalhadas'] = registro.horas_trabalhadas if registro.horas_trabalhadas is not None else ''
                    row['observacoes'] = registro.observacoes or ''
                    row['resultados_produtos'] = registro.resultados_produtos or ''
                    # Busca atividades
                    lista_atividades = dados_relatorio['atividades_por_ponto'].get(registro.id, [])
                    row['atividades'] = "; ".join(lista_atividades) if lista_atividades else ''
                    # Define status baseado nas horas
                    if registro.horas_trabalhadas is not None:
                         row['status'] = 'OK' if registro.horas_trabalhadas >= 8 else 'Parcial'
                    else:
                         row['status'] = 'Pendente'
            elif not is_fim_semana: # Dia útil sem registro
                row['status'] = 'Pendente (Sem Registro)'

            data_excel.append(row)

        # Define caminho e nome do arquivo
        static_dir = os.path.join(current_app.root_path, 'static')
        exports_dir = os.path.join(static_dir, 'exports')
        os.makedirs(exports_dir, exist_ok=True)
        filename = f"relatorio_{usuario.matricula}_{mes}_{ano}_{datetime.now().strftime('%Y%m%d%H%M%S')}.xlsx"
        output_path = os.path.join(exports_dir, filename)

        # Cria o arquivo Excel
        success = create_excel(data_excel, headers, output_path)

        if success:
            return f"exports/{filename}"
        else:
            raise Exception("Falha ao gerar Excel")
    except Exception as e:
        current_app.logger.error(f"Erro ao gerar Excel para user {user_id}, {mes}/{ano}: {e}", exc_info=True)
        return None

# Aliases antigos (mantidos por compatibilidade, mas podem ser removidos)
export_registros_pdf = generate_pdf
export_registros_excel = generate_excel
