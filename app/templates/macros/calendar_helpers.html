{# Macro para formatar timedelta (exemplo) #}
{% macro format_timedelta(delta, mostrar_sinal=False) %}
    {% if delta is none %}
        --:--
    {% else %}
        {% set total_seconds = delta.total_seconds() | int %}
        {% set sign = "-" if total_seconds < 0 else "+" if mostrar_sinal else "" %}
        {% set total_seconds = total_seconds | abs %}
        {% set hours = total_seconds // 3600 %}
        {% set minutes = (total_seconds % 3600) // 60 %}
        {{ "{}{:02d}:{:02d}".format(sign, hours, minutes) }}
    {% endif %}
{% endmacro %}

{# Macro para renderizar um dia no calendário mensal #}
{% macro render_calendar_day(day_date, current_month, feriados, afastamentos, atividades, dias_com_ponto) %}
    {% set is_today = day_date == today_date %}
    {% set is_current_month = day_date.month == current_month %}
    {% set is_weekend = day_date.weekday() >= 5 %}
    {% set feriado_desc = feriados.get(day_date) %}
    {% set afastamento_ativo = none %}
    {% for af in afastamentos if af.data_inicio <= day_date <= af.data_fim %}
        {% set afastamento_ativo = af %}
    {% endfor %}
    {% set atividade_dia = none %}
    {% for at in atividades if at.data == day_date %}
         {% set atividade_dia = at %}
    {% endfor %}
    {% set tem_ponto = day_date in dias_com_ponto %}

    {# Define classes CSS para o dia #}
    {% set day_classes = ['calendar-day', 'p-2', 'border'] %}
    {% if not is_current_month %}
        {% set _ = day_classes.append('text-muted') %}
        {% set _ = day_classes.append('bg-light') %}
    {% elif is_today %}
         {% set _ = day_classes.append('bg-primary') %}
         {% set _ = day_classes.append('text-white') %}
         {% set _ = day_classes.append('fw-bold') %}
    {% elif is_weekend %}
        {% set _ = day_classes.append('bg-secondary-subtle') %}
         {% set _ = day_classes.append('text-secondary-emphasis') %}
    {% endif %}
    {% if feriado_desc %}
         {% set _ = day_classes.append('calendar-feriado') %}
         {% set _ = day_classes.append('bg-info-subtle') %}
    {% elif afastamento_ativo %}
         {% set _ = day_classes.append('calendar-afastamento') %}
         {% set _ = day_classes.append('bg-warning-subtle') %}
    {% elif atividade_dia %}
         {% set _ = day_classes.append('calendar-atividade') %}
         {% set _ = day_classes.append('bg-success-subtle') %}
    {% endif %}


    <td class="{{ day_classes | join(' ') }}" style="min-height: 100px; vertical-align: top;">
        <div class="day-number mb-1">{{ day_date.day }}</div>
        <div class="day-content small">
            {% if is_current_month %}
                {% if feriado_desc %}
                    <div class="badge bg-info text-dark mb-1" title="{{ feriado_desc }}"><i class="bi bi-calendar-event"></i> Feriado</div>
                {% endif %}
                {% if afastamento_ativo %}
                     <div class="badge bg-warning text-dark mb-1" title="{{ afastamento_ativo.motivo }}"><i class="bi bi-airplane"></i> Afast.</div>
                {% endif %}
                 {% if atividade_dia %}
                     <div class="badge bg-success text-white mb-1" title="{{ atividade_dia.descricao }}"><i class="bi bi-briefcase"></i> Atividade</div>
                {% endif %}
                {% if tem_ponto and not afastamento_ativo and not atividade_dia %}
                    {# CORREÇÃO: Chamar visualizar_ponto com 'data' e não 'ponto_id' #}
                    <a href="{{ url_for('main.visualizar_ponto', data=day_date.isoformat()) }}" class="badge bg-success text-decoration-none" title="Ver pontos do dia">
                        <i class="bi bi-check-circle"></i> Ponto
                    </a>
                {% elif not is_weekend and not feriado_desc and not afastamento_ativo and not atividade_dia %}
                     {# Dia útil sem ponto - Opcional: link para registrar #}
                     <a href="{{ url_for('main.registrar_multiplo_ponto', data=day_date.isoformat()) }}" class="badge bg-light text-secondary text-decoration-none" title="Registrar pontos">
                         <i class="bi bi-pencil-square"></i> Registrar
                     </a>
                {% endif %}
            {% endif %}
        </div>
    </td>
{% endmacro %}

