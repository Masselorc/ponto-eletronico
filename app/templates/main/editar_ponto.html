{% extends 'base.html' %}

{% block title %}Editar Ponto{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2>Editar Registro</h2>
        <p class="text-muted">{{ ponto.data.strftime('%d/%m/%Y') }}</p>
    </div>
    <div class="col-md-6 text-end">
        <a href="{{ url_for('main.visualizar_ponto', ponto_id=ponto.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar para Detalhes
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Editar Horários</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.editar_ponto', ponto_id=ponto.id) }}" id="form-editar-ponto">
                    <!-- INÍCIO DO BLOCO DE AFASTAMENTO - SOLUÇÃO RADICAL -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="form-check mb-3">
                                <input type="checkbox" name="afastamento" id="check_afastamento" class="form-check-input" 
                                       {% if ponto.afastamento %}checked{% endif %}
                                       onchange="document.getElementById('div_tipo_afastamento').style.display = this.checked ? 'block' : 'none';
                                                document.getElementById('div_horarios').style.display = this.checked ? 'none' : 'flex';
                                                document.getElementById('entrada').disabled = this.checked;
                                                document.getElementById('saida_almoco').disabled = this.checked;
                                                document.getElementById('retorno_almoco').disabled = this.checked;
                                                document.getElementById('saida').disabled = this.checked;
                                                if(this.checked) {
                                                    document.getElementById('entrada').value = '';
                                                    document.getElementById('saida_almoco').value = '';
                                                    document.getElementById('retorno_almoco').value = '';
                                                    document.getElementById('saida').value = '';
                                                    document.getElementById('tipo_afastamento').required = true;
                                                } else {
                                                    document.getElementById('tipo_afastamento').required = false;
                                                }">
                                <label for="check_afastamento" class="form-check-label fw-bold">Férias ou outros afastamentos</label>
                                <small class="form-text text-muted d-block">Marque esta opção para registrar férias ou outros tipos de afastamento.</small>
                            </div>
                            <div id="div_tipo_afastamento" class="mb-3" style="display: {% if ponto.afastamento %}block{% else %}none{% endif %};">
                                <label for="tipo_afastamento" class="form-label">Tipo de Afastamento</label>
                                <select name="tipo_afastamento" id="tipo_afastamento" class="form-select" {% if ponto.afastamento %}required{% endif %}>
                                    <option value="ferias" {% if ponto.tipo_afastamento == 'ferias' %}selected{% endif %}>Férias</option>
                                    <option value="licenca_medica" {% if ponto.tipo_afastamento == 'licenca_medica' %}selected{% endif %}>Licença Médica</option>
                                    <option value="licenca_maternidade" {% if ponto.tipo_afastamento == 'licenca_maternidade' %}selected{% endif %}>Licença Maternidade/Paternidade</option>
                                    <option value="abono" {% if ponto.tipo_afastamento == 'abono' %}selected{% endif %}>Abono</option>
                                    <option value="outro" {% if ponto.tipo_afastamento == 'outro' %}selected{% endif %}>Outro</option>
                                </select>
                                <small class="form-text text-muted">Selecione o tipo de afastamento para este dia.</small>
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle me-2"></i> Ao registrar um afastamento, os campos de horário serão desabilitados automaticamente.
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- FIM DO BLOCO DE AFASTAMENTO - SOLUÇÃO RADICAL -->
                    
                    <div class="row mb-4" id="div_horarios" style="display: {% if ponto.afastamento %}none{% else %}flex{% endif %};">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Entrada</h6>
                                </div>
                                <div class="card-body">
                                    <label for="entrada" class="form-label">Hora de Entrada</label>
                                    <input type="time" name="entrada" id="entrada" class="form-control" 
                                           value="{{ ponto.entrada.strftime('%H:%M') if ponto.entrada else '' }}"
                                           {% if ponto.afastamento %}disabled{% endif %}>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Saída para Almoço</h6>
                                </div>
                                <div class="card-body">
                                    <label for="saida_almoco" class="form-label">Hora de Saída para Almoço</label>
                                    <input type="time" name="saida_almoco" id="saida_almoco" class="form-control" 
                                           value="{{ ponto.saida_almoco.strftime('%H:%M') if ponto.saida_almoco else '' }}"
                                           {% if ponto.afastamento %}disabled{% endif %}>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Retorno do Almoço</h6>
                                </div>
                                <div class="card-body">
                                    <label for="retorno_almoco" class="form-label">Hora de Retorno do Almoço</label>
                                    <input type="time" name="retorno_almoco" id="retorno_almoco" class="form-control" 
                                           value="{{ ponto.retorno_almoco.strftime('%H:%M') if ponto.retorno_almoco else '' }}"
                                           {% if ponto.afastamento %}disabled{% endif %}>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Saída</h6>
                                </div>
                                <div class="card-body">
                                    <label for="saida" class="form-label">Hora de Saída</label>
                                    <input type="time" name="saida" id="saida" class="form-control" 
                                           value="{{ ponto.saida.strftime('%H:%M') if ponto.saida else '' }}"
                                           {% if ponto.afastamento %}disabled{% endif %}>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">Salvar Alterações</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card-footer text-center">
                <p class="text-muted mb-0">Edite os horários desejados e clique em "Salvar Alterações"</p>
            </div>
        </div>
    </div>
</div>

<!-- Solução de fallback sem JavaScript -->
<noscript>
    <style>
        /* Estilos para quando JavaScript está desabilitado */
        .js-required {
            display: none !important;
        }
        
        .noscript-warning {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
        }
        
        /* Se for afastamento, esconde os campos de horário */
        {% if ponto.afastamento %}
        #div_horarios {
            display: none !important;
        }
        #div_tipo_afastamento {
            display: block !important;
        }
        {% else %}
        #div_horarios {
            display: flex !important;
        }
        #div_tipo_afastamento {
            display: none !important;
        }
        {% endif %}
    </style>
    
    <div class="noscript-warning">
        <h4>Atenção: JavaScript está desabilitado</h4>
        <p>Para melhor experiência, habilite o JavaScript no seu navegador. Algumas funcionalidades podem não funcionar corretamente.</p>
        <p>Se você está registrando um afastamento, marque a opção "Férias ou outros afastamentos" e envie o formulário. Os campos de horário serão ignorados.</p>
    </div>
    
    <!-- Campos ocultos para garantir que o formulário funcione sem JavaScript -->
    <input type="hidden" name="js_disabled" value="true">
</noscript>
{% endblock %}

{% block scripts %}
<script>
    // Configuração inicial
    document.addEventListener('DOMContentLoaded', function() {
        // Verifica o estado inicial do checkbox
        const checkAfastamento = document.getElementById('check_afastamento');
        if (checkAfastamento.checked) {
            document.getElementById('div_tipo_afastamento').style.display = 'block';
            document.getElementById('div_horarios').style.display = 'none';
            document.getElementById('entrada').disabled = true;
            document.getElementById('saida_almoco').disabled = true;
            document.getElementById('retorno_almoco').disabled = true;
            document.getElementById('saida').disabled = true;
            document.getElementById('tipo_afastamento').required = true;
        } else {
            document.getElementById('div_tipo_afastamento').style.display = 'none';
            document.getElementById('div_horarios').style.display = 'flex';
            document.getElementById('entrada').disabled = false;
            document.getElementById('saida_almoco').disabled = false;
            document.getElementById('retorno_almoco').disabled = false;
            document.getElementById('saida').disabled = false;
            document.getElementById('tipo_afastamento').required = false;
        }
    });
</script>
{% endblock %}
