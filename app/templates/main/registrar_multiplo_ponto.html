{% extends 'base.html' %}
{% from "_formhelpers.html" import render_field %} {# Importa macro de renderização de campo, se existir #}

{% block content %}
<div class="container mt-4">
    <h1>Registrar/Editar Pontos do Dia</h1>
    <p>Use este formulário para adicionar ou corrigir todos os registros de ponto para um dia específico.</p>

    <form method="POST" action="{{ url_for('main.registrar_multiplo_ponto') }}">
        {# CORREÇÃO Item 8: Usar form.hidden_tag() para incluir CSRF e outros campos ocultos #}
        {{ form.hidden_tag() }}

        <div class="row mb-3">
            <div class="col-md-4">
                {# Renderiza o campo de data usando macro ou diretamente #}
                {% if render_field %}
                    {{ render_field(form.data, class="form-control") }}
                {% else %}
                    <label for="{{ form.data.id }}" class="form-label">{{ form.data.label }}</label>
                    {{ form.data(class="form-control" + (" is-invalid" if form.data.errors else "")) }}
                    {% if form.data.errors %}
                        <div class="invalid-feedback">
                            {{ form.data.errors[0] }}
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <hr>
        <h4>Registros de Ponto:</h4>
         <div id="ponto-entries">
            {% for entry_form in form.pontos %}
            <div class="row g-3 mb-3 align-items-center ponto-entry">
                 {# Campo oculto para ID do subform, se necessário #}
                 {{ entry_form.hidden_tag() }}
                 <div class="col-md-3">
                     {% if render_field %}
                         {{ render_field(entry_form.hora, class="form-control", placeholder="HH:MM") }}
                     {% else %}
                         <label for="{{ entry_form.hora.id }}" class="form-label visually-hidden">{{ entry_form.hora.label }}</label>
                         {{ entry_form.hora(class="form-control time-input" + (" is-invalid" if entry_form.hora.errors else ""), placeholder="HH:MM") }}
                         {% if entry_form.hora.errors %}
                             <div class="invalid-feedback d-block">
                                 {{ entry_form.hora.errors[0] }}
                             </div>
                         {% endif %}
                     {% endif %}
                 </div>
                 <div class="col-md-3">
                      {% if render_field %}
                         {{ render_field(entry_form.tipo, class="form-select") }}
                     {% else %}
                         <label for="{{ entry_form.tipo.id }}" class="form-label visually-hidden">{{ entry_form.tipo.label }}</label>
                         {{ entry_form.tipo(class="form-select" + (" is-invalid" if entry_form.tipo.errors else "")) }}
                          {% if entry_form.tipo.errors %}
                             <div class="invalid-feedback d-block">
                                 {{ entry_form.tipo.errors[0] }}
                             </div>
                         {% endif %}
                     {% endif %}
                 </div>
                 <div class="col-md-5">
                     {% if render_field %}
                         {{ render_field(entry_form.observacao, class="form-control", placeholder="Observação (opcional)") }}
                     {% else %}
                          <label for="{{ entry_form.observacao.id }}" class="form-label visually-hidden">{{ entry_form.observacao.label }}</label>
                         {{ entry_form.observacao(class="form-control" + (" is-invalid" if entry_form.observacao.errors else ""), placeholder="Observação (opcional)") }}
                          {% if entry_form.observacao.errors %}
                             <div class="invalid-feedback d-block">
                                 {{ entry_form.observacao.errors[0] }}
                             </div>
                         {% endif %}
                     {% endif %}
                 </div>
                 <div class="col-md-1">
                     {# Botão para remover a linha (exceto a primeira talvez) - requer JS #}
                     <button type="button" class="btn btn-sm btn-outline-danger remove-entry-btn" title="Remover Registro">
                         <i class="bi bi-x-lg"></i>
                     </button>
                 </div>
            </div>
            {% endfor %}
        </div>

        <button type="button" id="add-entry-btn" class="btn btn-sm btn-outline-success mb-3">
            <i class="bi bi-plus-circle"></i> Adicionar Registro
        </button>

        <div class="mt-4">
            {{ form.submit(class="btn btn-primary") }}
            <a href="{{ url_for('main.visualizar_ponto', data=form.data.data.isoformat() if form.data.data else '') }}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const entriesContainer = document.getElementById('ponto-entries');
    const addEntryButton = document.getElementById('add-entry-btn');

    // Função para adicionar listener de remoção
    function addRemoveListener(button) {
        button.addEventListener('click', function() {
            // Não remove se for a última linha (?) ou adiciona validação
            if (entriesContainer.querySelectorAll('.ponto-entry').length > 1) {
                 this.closest('.ponto-entry').remove();
                 updateEntryIndices(); // Reindexa os campos após remover
            } else {
                // Limpa os campos da última linha em vez de remover?
                const entry = this.closest('.ponto-entry');
                entry.querySelectorAll('input[type="time"], input[type="text"], select, textarea').forEach(input => input.value = '');
                // Talvez resetar o select 'tipo' para 'Entrada'
                const tipoSelect = entry.querySelector('select[name*="tipo"]');
                if(tipoSelect) tipoSelect.value = 'Entrada';

                alert("Pelo menos um registro é necessário. Os campos foram limpos.");
            }
        });
    }

    // Função para reindexar nomes e IDs dos campos
    function updateEntryIndices() {
        const entries = entriesContainer.querySelectorAll('.ponto-entry');
        entries.forEach((entry, index) => {
            entry.querySelectorAll('input, select, textarea, label').forEach(element => {
                const name = element.getAttribute('name');
                const id = element.getAttribute('id');
                const labelFor = element.getAttribute('for');

                if (name) {
                    element.setAttribute('name', name.replace(/pontos-\d+-/, `pontos-${index}-`));
                }
                if (id) {
                    element.setAttribute('id', id.replace(/pontos-\d+-/, `pontos-${index}-`));
                }
                 if (labelFor) {
                    element.setAttribute('for', labelFor.replace(/pontos-\d+-/, `pontos-${index}-`));
                }
            });
        });
    }


    // Adiciona listener aos botões de remoção existentes
    entriesContainer.querySelectorAll('.remove-entry-btn').forEach(addRemoveListener);

    // Adiciona nova entrada
    addEntryButton.addEventListener('click', function() {
        const lastEntry = entriesContainer.querySelector('.ponto-entry:last-of-type');
        if (!lastEntry) return; // Não faz nada se não houver entradas

        const newEntry = lastEntry.cloneNode(true);
        const currentIndex = entriesContainer.querySelectorAll('.ponto-entry').length;

        // Limpa os valores e ajusta nomes/IDs dos campos clonados
        newEntry.querySelectorAll('input, select, textarea').forEach(input => {
            const name = input.getAttribute('name');
            const id = input.getAttribute('id');
            input.value = ''; // Limpa valor
            if (name) {
                 input.setAttribute('name', name.replace(/pontos-\d+-/, `pontos-${currentIndex}-`));
            }
             if (id) {
                input.setAttribute('id', id.replace(/pontos-\d+-/, `pontos-${currentIndex}-`));
                // Limpa estado de erro visual
                input.classList.remove('is-invalid');
            }
             // Limpa mensagens de erro associadas
             const errorDiv = newEntry.querySelector(`div.invalid-feedback[for="${id}"]`) || input.closest('.col-md-3, .col-md-5')?.querySelector('.invalid-feedback');
             if (errorDiv) errorDiv.textContent = '';

        });
         // Ajusta 'for' dos labels
         newEntry.querySelectorAll('label').forEach(label => {
             const labelFor = label.getAttribute('for');
              if (labelFor) {
                 label.setAttribute('for', labelFor.replace(/pontos-\d+-/, `pontos-${currentIndex}-`));
             }
         });

        // Adiciona listener ao novo botão de remover
        const newRemoveButton = newEntry.querySelector('.remove-entry-btn');
        if (newRemoveButton) {
            addRemoveListener(newRemoveButton);
        }

        entriesContainer.appendChild(newEntry);
    });
});
</script>
{% endblock %}
