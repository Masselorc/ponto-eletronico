{% extends 'base.html' %}

{% block title %}Registro de Ponto{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2>Registro de Ponto</h2>
        <p class="text-muted">Preencha os horários para um mesmo dia</p>
    </div>
    <div class="col-md-6 text-end">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Horário Atual</h5>
                <h3 id="relogio" class="display-4 mb-0">00:00:00</h3>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Registro de Horários</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.registrar_multiplo_ponto') }}" id="form-registro-ponto">
                    {{ form.hidden_tag() }}
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="mb-3">
                                {{ form.data.label(class="form-label") }}
                                {{ form.data(class="form-control", type="date") }}
                                {% for error in form.data.errors %}
                                <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- INÍCIO DO BLOCO DE AFASTAMENTO - SOLUÇÃO RADICAL -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="form-check mb-3">
                                <input type="checkbox" name="afastamento" id="check_afastamento" class="form-check-input" 
                                       onchange="document.getElementById('div_tipo_afastamento').style.display = this.checked ? 'block' : 'none';
                                                document.getElementById('div_horarios').style.display = this.checked ? 'none' : 'flex';
                                                document.getElementById('hora_entrada_input').disabled = this.checked;
                                                document.getElementById('hora_saida_almoco_input').disabled = this.checked;
                                                document.getElementById('hora_retorno_almoco_input').disabled = this.checked;
                                                document.getElementById('hora_saida_input').disabled = this.checked;
                                                document.getElementById('btn_hora_entrada').disabled = this.checked;
                                                document.getElementById('btn_hora_saida_almoco').disabled = this.checked;
                                                document.getElementById('btn_hora_retorno_almoco').disabled = this.checked;
                                                document.getElementById('btn_hora_saida').disabled = this.checked;
                                                if(this.checked) {
                                                    document.getElementById('hora_entrada_input').value = '';
                                                    document.getElementById('hora_saida_almoco_input').value = '';
                                                    document.getElementById('hora_retorno_almoco_input').value = '';
                                                    document.getElementById('hora_saida_input').value = '';
                                                    document.getElementById('tipo_afastamento').required = true;
                                                } else {
                                                    document.getElementById('tipo_afastamento').required = false;
                                                }">
                                <label for="check_afastamento" class="form-check-label fw-bold">Férias ou outros afastamentos</label>
                                <small class="form-text text-muted d-block">Marque esta opção para registrar férias ou outros tipos de afastamento.</small>
                            </div>
                            <div id="div_tipo_afastamento" class="mb-3" style="display: none;">
                                <label for="tipo_afastamento" class="form-label">Tipo de Afastamento</label>
                                <select name="tipo_afastamento" id="tipo_afastamento" class="form-select">
                                    <option value="ferias">Férias</option>
                                    <option value="licenca_medica">Licença Médica</option>
                                    <option value="licenca_maternidade">Licença Maternidade/Paternidade</option>
                                    <option value="abono">Abono</option>
                                    <option value="outro">Outro</option>
                                </select>
                                <small class="form-text text-muted">Selecione o tipo de afastamento para este dia.</small>
                                <div class="alert alert-info mt-3">
                                    <i class="fas fa-info-circle me-2"></i> Ao registrar um afastamento, os campos de horário serão desabilitados automaticamente.
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- FIM DO BLOCO DE AFASTAMENTO - SOLUÇÃO RADICAL -->
                    
                    <div class="row mb-4" id="div_horarios">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Entrada</h6>
                                </div>
                                <div class="card-body">
                                    <label for="hora_entrada_input" class="form-label">Hora de Entrada</label>
                                    <input type="time" name="entrada" id="hora_entrada_input" class="form-control">
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2 btn-hora-atual" 
                                            id="btn_hora_entrada" 
                                            onclick="document.getElementById('hora_entrada_input').value = new Date().toTimeString().slice(0, 5);">
                                        Usar horário atual
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Saída para Almoço</h6>
                                </div>
                                <div class="card-body">
                                    <label for="hora_saida_almoco_input" class="form-label">Hora de Saída para Almoço</label>
                                    <input type="time" name="saida_almoco" id="hora_saida_almoco_input" class="form-control">
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2 btn-hora-atual" 
                                            id="btn_hora_saida_almoco" 
                                            onclick="document.getElementById('hora_saida_almoco_input').value = new Date().toTimeString().slice(0, 5);">
                                        Usar horário atual
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Retorno do Almoço</h6>
                                </div>
                                <div class="card-body">
                                    <label for="hora_retorno_almoco_input" class="form-label">Hora de Retorno do Almoço</label>
                                    <input type="time" name="retorno_almoco" id="hora_retorno_almoco_input" class="form-control">
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2 btn-hora-atual" 
                                            id="btn_hora_retorno_almoco" 
                                            onclick="document.getElementById('hora_retorno_almoco_input').value = new Date().toTimeString().slice(0, 5);">
                                        Usar horário atual
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Saída</h6>
                                </div>
                                <div class="card-body">
                                    <label for="hora_saida_input" class="form-label">Hora de Saída</label>
                                    <input type="time" name="saida" id="hora_saida_input" class="form-control">
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2 btn-hora-atual" 
                                            id="btn_hora_saida" 
                                            onclick="document.getElementById('hora_saida_input').value = new Date().toTimeString().slice(0, 5);">
                                        Usar horário atual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Atividades Realizadas</h6>
                                </div>
                                <div class="card-body">
                                    {{ form.atividades.label(class="form-label") }}
                                    {{ form.atividades(class="form-control", rows=4) }}
                                    <small class="form-text text-muted">{{ form.atividades.description }}</small>
                                    {% for error in form.atividades.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Observações</h6>
                                </div>
                                <div class="card-body">
                                    {{ form.observacoes.label(class="form-label") }}
                                    {{ form.observacoes(class="form-control", rows=2) }}
                                    {% for error in form.observacoes.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">Registrar Horários</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card-footer text-center">
                <p class="text-muted mb-0">Preencha os horários desejados e clique em "Registrar Horários"</p>
                <p class="text-muted">Você pode preencher apenas os horários que deseja registrar</p>
            </div>
        </div>
    </div>
</div>

<!-- Solução de fallback sem JavaScript -->
<noscript>
    <style>
        #div_horarios.js-disabled {
            display: none !important;
        }
        #div_tipo_afastamento.js-enabled {
            display: block !important;
        }
        .noscript-warning {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
        }
    </style>
    <div class="noscript-warning">
        <h4>Atenção: JavaScript está desabilitado</h4>
        <p>Para melhor experiência, habilite o JavaScript no seu navegador. Algumas funcionalidades podem não funcionar corretamente.</p>
    </div>
</noscript>
{% endblock %}

{% block scripts %}
<script>
    // Atualiza o relógio a cada segundo
    function atualizarRelogio() {
        const agora = new Date();
        const horas = agora.getHours().toString().padStart(2, '0');
        const minutos = agora.getMinutes().toString().padStart(2, '0');
        const segundos = agora.getSeconds().toString().padStart(2, '0');
        document.getElementById('relogio').textContent = `${horas}:${minutos}:${segundos}`;
    }
    
    // Atualiza o relógio imediatamente e depois a cada segundo
    atualizarRelogio();
    setInterval(atualizarRelogio, 1000);
    
    // Configuração inicial
    document.addEventListener('DOMContentLoaded', function() {
        // Preenche a data atual no campo de data
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = (hoje.getMonth() + 1).toString().padStart(2, '0');
        const dia = hoje.getDate().toString().padStart(2, '0');
        document.getElementById('data').value = `${ano}-${mes}-${dia}`;
        
        // Verifica o estado inicial do checkbox
        const checkAfastamento = document.getElementById('check_afastamento');
        if (checkAfastamento.checked) {
            document.getElementById('div_tipo_afastamento').style.display = 'block';
            document.getElementById('div_horarios').style.display = 'none';
            document.getElementById('hora_entrada_input').disabled = true;
            document.getElementById('hora_saida_almoco_input').disabled = true;
            document.getElementById('hora_retorno_almoco_input').disabled = true;
            document.getElementById('hora_saida_input').disabled = true;
            document.getElementById('btn_hora_entrada').disabled = true;
            document.getElementById('btn_hora_saida_almoco').disabled = true;
            document.getElementById('btn_hora_retorno_almoco').disabled = true;
            document.getElementById('btn_hora_saida').disabled = true;
            document.getElementById('tipo_afastamento').required = true;
        } else {
            document.getElementById('div_tipo_afastamento').style.display = 'none';
            document.getElementById('div_horarios').style.display = 'flex';
            document.getElementById('hora_entrada_input').disabled = false;
            document.getElementById('hora_saida_almoco_input').disabled = false;
            document.getElementById('hora_retorno_almoco_input').disabled = false;
            document.getElementById('hora_saida_input').disabled = false;
            document.getElementById('btn_hora_entrada').disabled = false;
            document.getElementById('btn_hora_saida_almoco').disabled = false;
            document.getElementById('btn_hora_retorno_almoco').disabled = false;
            document.getElementById('btn_hora_saida').disabled = false;
            document.getElementById('tipo_afastamento').required = false;
        }
    });
</script>
{% endblock %}
