{% extends 'base.html' %}

{% block title %}Relatório Mensal{% endblock %}

{% block extra_css %}
<style>
    /* Estilo para a linha de detalhes expansível */
    .detalhes-row td {
        background-color: #f8f9fa !important;
        padding: 0.75rem 1rem;
        border-top: 0;
        font-size: 0.85rem;
    }
    .detalhes-row h6 {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        color: #6c757d;
    }
    .detalhes-row ul { padding-left: 1.2rem; margin-bottom: 0.5rem; }
    .detalhes-row p  { margin-bottom: 0.5rem; }

    /* Linha principal clicável */
    .linha-clicavel       { cursor: pointer; }
    .linha-clicavel:hover { background-color: rgba(0,0,0,.05); }

    /* Ícone seta */
    .expand-icon { display:inline-block; margin-left:5px; transition:transform .2s; font-size:.7em; color:#6c757d; }
    tr[data-bs-toggle="collapse"][aria-expanded="true"] .expand-icon { transform: rotate(90deg); }

    /* alinhamento vertical */
    .table.align-middle th,
    .table.align-middle td { vertical-align: middle; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  … <!-- conteúdo de cabeçalho e resumo mantido -->

  <!-- Tabela de Registros -->
  <div class="card shadow-sm">
    <div class="card-header"><h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Registros do Mês</h5></div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th class="text-nowrap ps-3">Data</th>
              <th>Dia</th>
              <th class="text-center">Entrada</th>
              <th class="text-center text-nowrap">Início Almoço</th>
              <th class="text-center text-nowrap">Fim Almoço</th>
              <th class="text-center">Saída</th>
              <th class="text-center text-nowrap">Horas Trab.</th>
              <th class="text-center">Status</th>
              <th class="text-center">Atividades</th>
              <th class="text-center pe-3">Ações</th>
            </tr>
          </thead>
          <tbody>
          {% set dias_semana = ['Seg','Ter','Qua','Qui','Sex','Sáb','Dom'] %}
          {% for dia_num in range(1, ultimo_dia.day + 1) %}
            {% set data_atual      = date(ano_atual, mes_atual, dia_num) %}
            {% set dia_semana_idx = data_atual.weekday() %}
            {% set dia_semana     = dias_semana[dia_semana_idx] %}
            {% set registro       = registros_por_data.get(data_atual) %}
            {% set is_feriado     = data_atual in feriados_datas %}
            {% set is_fim_semana  = dia_semana_idx >= 5 %}
            {% set atividades     = atividades_por_ponto.get(registro.id, []) if registro else [] %}
            {% set tem_detalhes   = registro and (registro.observacoes or atividades or registro.resultados_produtos) %}

            {# -------- classe da linha -------- #}
            {% set tr_class = [] %}
            {% if is_feriado                        %}{% set _ = tr_class.append('table-warning') %}
            {% elif is_fim_semana                  %}{% set _ = tr_class.append('table-light text-muted') %}
            {% elif registro and registro.afastamento %}{% set _ = tr_class.append('table-info') %}
            {% elif registro and registro.horas_trabalhadas is not none and registro.horas_trabalhadas >= 8 %}{% set _ = tr_class.append('table-success') %}
            {% elif registro and registro.horas_trabalhadas is not none %}{% set _ = tr_class.append('table-warning') %}
            {% elif not registro and not is_fim_semana %}{% set _ = tr_class.append('table-danger') %}
            {% endif %}
            {% if tem_detalhes %}{% set _ = tr_class.append('linha-clicavel') %}{% endif %}

            <tr class="{{ tr_class|join(' ') }}"
                {% if tem_detalhes %}
                  data-bs-toggle="collapse" data-bs-target="#detalhes-{{ dia_num }}"
                  aria-expanded="false" aria-controls="detalhes-{{ dia_num }}"
                {% endif %}>
              <td class="text-nowrap ps-3">
                {{ data_atual.strftime('%d/%m') }}
                {% if tem_detalhes %}<i class="fas fa-chevron-right expand-icon"></i>{% endif %}
              </td>
              <td>{{ dia_semana }}</td>

              {# ---------- Linhas especiais ---------- #}
              {% if is_feriado %}
                <td colspan="6" class="text-center fst-italic">{{ feriados_dict[data_atual] }}</td>
                <td class="text-center"><span class="badge bg-warning-subtle text-dark">Feriado</span></td>
                <td class="text-center text-nowrap pe-3">-</td>

              {% elif is_fim_semana %}
                <td colspan="6" class="text-center fst-italic">Fim de Semana</td>
                <td class="text-center"><span class="badge bg-light text-secondary">FDS</span></td>
                <td class="text-center text-nowrap pe-3">-</td>

              {% elif registro %}
                {% if registro.afastamento %}
                  <td colspan="6" class="text-center fst-italic">{{ registro.tipo_afastamento|default('Afastamento', true)|capitalize }}</td>
                  <td class="text-center"><span class="badge bg-info text-dark">Afast.</span></td>
                  <td class="text-center text-nowrap pe-3">
                    … <!-- botões de ação --> …
                  </td>

                {% else %} {# ---------- Dia trabalhado ---------- #}
                  <td class="text-center">{{ registro.entrada.strftime('%H:%M') if registro.entrada else '-' }}</td>
                  {% if registro.saida_almoco and registro.retorno_almoco %}
                    <td class="text-center">{{ registro.saida_almoco.strftime('%H:%M') }}</td>
                    <td class="text-center">{{ registro.retorno_almoco.strftime('%H:%M') }}</td>
                  {% elif registro.saida_almoco or registro.retorno_almoco %}
                    <td class="text-center">{{ registro.saida_almoco.strftime('%H:%M') if registro.saida_almoco else '-' }}</td>
                    <td class="text-center">{{ registro.retorno_almoco.strftime('%H:%M') if registro.retorno_almoco else '-' }}</td>
                  {% else %}
                    <td colspan="2" class="text-center text-muted small fst-italic">Sem registro de almoço</td>
                  {% endif %}
                  <td class="text-center">{{ registro.saida.strftime('%H:%M') if registro.saida else '-' }}</td>
                  <td class="text-center fw-bold">{{ registro.horas_trabalhadas is not none and ("%.2f"|format(registro.horas_trabalhadas) ~ 'h') or '-' }}</td>
                  <td class="text-center">
                    {% if registro.horas_trabalhadas is not none and registro.horas_trabalhadas >= 8 %}
                      <span class="badge bg-success">OK</span>
                    {% elif registro.horas_trabalhadas is not none %}
                      <span class="badge bg-warning text-dark">Parcial</span>
                    {% else %}
                      <span class="badge bg-secondary">Pendente</span>
                    {% endif %}
                  </td>
                  <td class="text-center">{% if atividades %}<i class="fas fa-list-check text-success"></i>{% else %}-{% endif %}</td>
                  <td class="text-center text-nowrap pe-3">… <!-- botões --> …</td>
                {% endif %}

              {% else %} {# ---------- Dia útil sem registro ---------- #}
                <td colspan="6" class="text-center fst-italic">Sem Registro</td>
                <td class="text-center"><span class="badge bg-danger">Pendente</span></td>
                <td class="text-center text-nowrap pe-3">… <!-- botões --> …</td>
              {% endif %}
            </tr>

            {% if tem_detalhes %}
              <tr id="detalhes-{{ dia_num }}" class="collapse">
                <td colspan="10" class="detalhes-row"> … </td>
              </tr>
            {% endif %}
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
