{# ... (início do template) ... #}

            {# --- Seção de Autoavaliação / Exportação --- #}
            <div class="card mt-4 mb-5 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Relatório Completo com Autoavaliação</h5>
                </div>
                <div class="card-body p-4">
                    {# --- Lógica Condicional Atualizada --- #}
                    {% if relatorio_completo_salvo %}
                        {# Se já existe um relatório salvo, mostra botões de visualizar e editar #}
                        <p class="text-success"><i class="fas fa-check-circle me-1"></i> Relatório completo com autoavaliação já foi salvo para este mês.</p>
                        <p>Você pode visualizá-lo ou editar as informações salvas.</p>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            {# --- CORREÇÃO: Botão aponta para a nova rota de visualização HTML --- #}
                            <a href="{{ url_for('main.visualizar_relatorio_completo', user_id=usuario.id, mes=mes_atual, ano=ano_atual) }}" class="btn btn-primary"> {# Mudado para primary #}
                                <i class="fas fa-eye me-2"></i> Visualizar Relatório Completo
                            </a>
                            {# Botão Editar que abre o collapse (mantido) #}
                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#autoavaliacaoCollapse" aria-expanded="false" aria-controls="autoavaliacaoCollapse">
                                <i class="fas fa-edit me-1"></i> Editar Autoavaliação Salva
                            </button>
                        </div>
                    {% else %}
                        {# Se não existe, mostra o botão para adicionar/salvar #}
                        <p>Adicione sua autoavaliação para salvar o relatório completo.</p>
                        <div class="text-center">
                            <button class="btn btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#autoavaliacaoCollapse" aria-expanded="false" aria-controls="autoavaliacaoCollapse">
                                <i class="fas fa-plus-circle me-2"></i>Adicionar Autoavaliação
                            </button>
                        </div>
                    {% endif %}

                    {# Formulário de autoavaliação (mantido dentro do collapse) #}
                    <div class="collapse mt-3" id="autoavaliacaoCollapse">
                        {# ... (conteúdo do formulário inalterado) ... #}
                         {% if form_completo %}
                            <form method="POST" action="{{ url_for('main.salvar_relatorio_completo') }}" novalidate>
                                {{ form_completo.hidden_tag() }} {# Token CSRF #}
                                {{ form_completo.user_id() }} {# Mantém campos ocultos #}
                                {{ form_completo.mes() }}
                                {{ form_completo.ano() }}

                                {# Campo Autoavaliação #}
                                <div class="mb-3">
                                    <label for="{{ form_completo.autoavaliacao.id }}" class="form-label fw-bold">{{ form_completo.autoavaliacao.label.text }}</label>
                                    <p class="form-text text-muted mt-0 mb-2">{{ form_completo.autoavaliacao.description }}</p>
                                    {{ form_completo.autoavaliacao(class="form-control" + (" is-invalid" if form_completo.autoavaliacao.errors else "")) }}
                                    {% if form_completo.autoavaliacao.errors %}<div class="invalid-feedback">{% for e in form_completo.autoavaliacao.errors %}{{e}}{% endfor %}</div>{% endif %}
                                </div>

                                {# Campo Dificuldades #}
                                <div class="mb-3">
                                    {{ form_completo.dificuldades.label(class="form-label fw-bold") }}
                                    {{ form_completo.dificuldades(class="form-control" + (" is-invalid" if form_completo.dificuldades.errors else "")) }}
                                    {% if form_completo.dificuldades.errors %}<div class="invalid-feedback">{% for e in form_completo.dificuldades.errors %}{{e}}{% endfor %}</div>{% endif %}
                                </div>

                                {# Campo Sugestões #}
                                <div class="mb-3">
                                    {{ form_completo.sugestoes.label(class="form-label fw-bold") }}
                                    {{ form_completo.sugestoes(class="form-control" + (" is-invalid" if form_completo.sugestoes.errors else "")) }}
                                    {% if form_completo.sugestoes.errors %}<div class="invalid-feedback">{% for e in form_completo.sugestoes.errors %}{{e}}{% endfor %}</div>{% endif %}
                                </div>

                                {# Campo Declaração (Checkbox) #}
                                <div class="mb-3 form-check">
                                    {{ form_completo.declaracao(class="form-check-input" + (" is-invalid" if form_completo.declaracao.errors else ""), id="declaracaoCheck") }}
                                    {{ form_completo.declaracao.label(class="form-check-label", for="declaracaoCheck") }}
                                    {% if form_completo.declaracao.errors %}<div class="invalid-feedback d-block">{% for e in form_completo.declaracao.errors %}{{e}}{% endfor %}</div>{% endif %}
                                </div>

                                {# Exibição da Data #}
                                <div class="mb-3">
                                    <p><strong>DATA:</strong> {{ date_obj.today().strftime('%d/%m/%Y') }}</p>
                                </div>

                                {# Botão de Submit (para salvar ou atualizar) #}
                                <div class="d-grid">
                                     {{ form_completo.submit_salvar(class="btn btn-primary") }}
                                </div>
                            </form>
                        {% else %}
                            <p class="text-danger">Erro: Formulário de autoavaliação não pôde ser carregado.</p>
                        {% endif %}
                    </div> {# Fim do collapse #}
                </div> {# Fim do card-body #}
            </div> {# Fim do card #}
            {# --- Fim da Seção de Autoavaliação / Exportação --- #}
        </div> {# Fim col-md-12 #}
    </div> {# Fim row #}
</div> {# Fim container #}
{% endblock %}
