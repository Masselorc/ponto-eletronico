{% extends 'base.html' %}

{% block title %}Calendário{% endblock %}

{% block extra_css %}
<style>
    .calendario-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    
    .dia-semana {
        text-align: center;
        font-weight: bold;
        padding: 10px;
        background-color: #f8f9fa;
    }
    
    .dia {
        min-height: 120px;
        border: 1px solid #dee2e6;
        padding: 8px;
        position: relative;
    }
    
    .dia-numero {
        position: absolute;
        top: 5px;
        right: 8px;
        font-weight: bold;
    }
    
    .dia-conteudo {
        margin-top: 25px;
    }
    
    .dia-hoje {
        background-color: #e8f4ff;
        border: 2px solid #0d6efd;
    }
    
    .dia-feriado {
        background-color: #ffecec;
    }
    
    .dia-fim-semana {
        background-color: #f8f9fa;
    }
    
    .dia-outro-mes {
        background-color: #f8f9fa;
        opacity: 0.5;
    }
    
    .horas-badge {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 0.8rem;
        margin-bottom: 5px;
    }
    
    .horario-item {
        font-size: 0.8rem;
        margin-bottom: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2>Calendário</h2>
        <p class="text-muted">{{ mes_atual }}/{{ ano_atual }}</p>
    </div>
    <div class="col-md-6 text-end">
        <div class="btn-group">
            <a href="{{ url_for('main.calendario', mes=mes_atual-1 if mes_atual > 1 else 12, ano=ano_atual if mes_atual > 1 else ano_atual-1) }}" class="btn btn-outline-primary">
                <i class="fas fa-chevron-left"></i> Mês Anterior
            </a>
            <a href="{{ url_for('main.calendario') }}" class="btn btn-primary">Mês Atual</a>
            <a href="{{ url_for('main.calendario', mes=mes_atual+1 if mes_atual < 12 else 1, ano=ano_atual if mes_atual < 12 else ano_atual+1) }}" class="btn btn-outline-primary">
                Próximo Mês <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

<div class="calendario-container mb-4">
    <div class="calendario-grid">
        <div class="dia-semana">Domingo</div>
        <div class="dia-semana">Segunda</div>
        <div class="dia-semana">Terça</div>
        <div class="dia-semana">Quarta</div>
        <div class="dia-semana">Quinta</div>
        <div class="dia-semana">Sexta</div>
        <div class="dia-semana">Sábado</div>
        
        {% set primeiro_dia = namespace(data=primeiro_dia) %}
        {% set ultimo_dia = namespace(data=ultimo_dia) %}
        
        {# Dias do mês anterior para preencher a primeira semana #}
        {% set primeiro_dia_semana = primeiro_dia.data.weekday() %}
        {% for i in range(primeiro_dia_semana) %}
            {% set dia_anterior = primeiro_dia.data - timedelta(days=primeiro_dia_semana-i) %}
            <div class="dia dia-outro-mes">
                <div class="dia-numero">{{ dia_anterior.day }}</div>
                <div class="dia-conteudo"></div>
            </div>
        {% endfor %}
        
        {# Dias do mês atual #}
        {% for dia in range(1, ultimo_dia.data.day + 1) %}
            {% set data_atual = date(ano_atual, mes_atual, dia) %}
            {% set eh_hoje = data_atual == hoje %}
            {% set eh_fim_semana = data_atual.weekday() >= 5 %}
            {% set eh_feriado = data_atual in feriados_datas %}
            
            <div class="dia 
                {% if eh_hoje %}dia-hoje{% endif %}
                {% if eh_fim_semana %}dia-fim-semana{% endif %}
                {% if eh_feriado %}dia-feriado{% endif %}">
                <div class="dia-numero">{{ dia }}</div>
                <div class="dia-conteudo">
                    {% if data_atual in registros %}
                        {% set registro = registros[data_atual] %}
                        {% if registro.horas_trabalhadas %}
                            <div class="horas-badge 
                                {% if registro.horas_trabalhadas >= 8 %}bg-success{% else %}bg-warning{% endif %}">
                                {{ "%.1f"|format(registro.horas_trabalhadas) }}h
                            </div>
                        {% endif %}
                        
                        {% if registro.entrada %}
                            <div class="horario-item">
                                <i class="fas fa-sign-in-alt text-success"></i> {{ registro.entrada.strftime('%H:%M') }}
                            </div>
                        {% endif %}
                        
                        {% if registro.saida %}
                            <div class="horario-item">
                                <i class="fas fa-sign-out-alt text-danger"></i> {{ registro.saida.strftime('%H:%M') }}
                            </div>
                        {% endif %}
                        
                        <a href="{{ url_for('main.visualizar_ponto', ponto_id=registro.id) }}" class="btn btn-sm btn-outline-primary mt-2">
                            <i class="fas fa-eye"></i>
                        </a>
                    {% elif not eh_fim_semana and not eh_feriado and data_atual <= hoje %}
                        <span class="badge bg-secondary">Sem registro</span>
                    {% endif %}
                    
                    {% if eh_feriado %}
                        <div class="mt-1">
                            <span class="badge bg-danger">Feriado</span>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
        
        {# Dias do próximo mês para completar a última semana #}
        {% set ultimo_dia_semana = ultimo_dia.data.weekday() %}
        {% for i in range(6 - ultimo_dia_semana) %}
            {% set dia_seguinte = ultimo_dia.data + timedelta(days=i+1) %}
            <div class="dia dia-outro-mes">
                <div class="dia-numero">{{ dia_seguinte.day }}</div>
                <div class="dia-conteudo"></div>
            </div>
        {% endfor %}
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Resumo do Mês</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Dias Trabalhados</h6>
                                <h3 class="card-title">{{ registros|length }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Total de Horas</h6>
                                <h3 class="card-title">
                                    {% set total_horas = namespace(valor=0) %}
                                    {% for registro in registros.values() %}
                                        {% if registro.horas_trabalhadas %}
                                            {% set total_horas.valor = total_horas.valor + registro.horas_trabalhadas %}
                                        {% endif %}
                                    {% endfor %}
                                    {{ "%.1f"|format(total_horas.valor) }}h
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Média Diária</h6>
                                <h3 class="card-title">
                                    {% if registros|length > 0 %}
                                        {{ "%.1f"|format(total_horas.valor / registros|length) }}h
                                    {% else %}
                                        0h
                                    {% endif %}
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar para Dashboard
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
