{% extends 'base.html' %}

{% block title %}Calendário{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendario.css') }}">
<style>
    .calendario-table {
        table-layout: fixed;
    }
    
    .calendario-table td {
        height: 120px;
        vertical-align: top;
        padding: 5px;
        position: relative;
    }
    
    .numero-dia {
        font-weight: bold;
        font-size: 1.2em;
        margin-bottom: 5px;
    }
    
    .dia-outro-mes {
        background-color: #f8f9fa;
        color: #adb5bd;
    }
    
    .hoje {
        background-color: #e8f4f8;
        border: 2px solid #0d6efd;
    }
    
    .fim-de-semana {
        background-color: #f8f9fa;
    }
    
    .feriado {
        background-color: #ffebee;
    }
    
    .registro-completo {
        margin-top: 5px;
    }
    
    .horarios {
        display: flex;
        justify-content: space-between;
        font-size: 0.8em;
        margin-bottom: 3px;
    }
    
    .entrada, .saida {
        background-color: #e9ecef;
        padding: 2px 5px;
        border-radius: 3px;
    }
    
    .horas-badge, .sem-registro-badge, .feriado-badge, .afastamento-badge {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        margin-top: 3px;
        width: 100%;
        text-align: center;
    }
    
    .horas-completas {
        background-color: #d4edda;
        color: #155724;
    }
    
    .horas-parciais {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .sem-registro-badge {
        background-color: #e9ecef;
        color: #6c757d;
    }
    
    .feriado-badge {
        background-color: #ffebee;
        color: #b71c1c;
    }
    
    .afastamento-badge {
        background-color: #e2d9f3;
        color: #6f42c1;
    }
    
    .ferias-badge {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .licenca-badge {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .abono-badge {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .acoes-dia {
        position: absolute;
        bottom: 5px;
        right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6">
        <h2>Calendário</h2>
        <p class="text-muted">
            {% if current_user.id == usuario.id %}
                Meus registros de ponto
            {% else %}
                Registros de ponto de {{ usuario.name }}
            {% endif %}
        </p>
    </div>
    <div class="col-md-6 text-end">
        <div class="btn-group">
            <a href="{{ url_for('main.calendario', user_id=usuario.id, mes=(mes_atual-1 if mes_atual > 1 else 12), ano=(ano_atual if mes_atual > 1 else ano_atual-1)) }}" class="btn btn-outline-primary">
                <i class="fas fa-chevron-left"></i> Mês Anterior
            </a>
            <a href="{{ url_for('main.calendario', user_id=usuario.id, mes=(mes_atual+1 if mes_atual < 12 else 1), ano=(ano_atual if mes_atual < 12 else ano_atual+1)) }}" class="btn btn-outline-primary">
                Próximo Mês <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

{% if current_user.is_admin and usuarios %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Selecionar Usuário</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <select id="usuario-select" class="form-select">
                            <option value="{{ current_user.id }}" {% if usuario.id == current_user.id %}selected{% endif %}>Meus Registros</option>
                            {% for user in usuarios %}
                                {% if user.id != current_user.id %}
                                <option value="{{ user.id }}" {% if usuario.id == user.id %}selected{% endif %}>{{ user.name }} ({{ user.matricula }})</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button id="btn-visualizar" class="btn btn-primary w-100">Visualizar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">{{ nome_mes }} de {{ ano_atual }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered calendario-table">
                        <thead>
                            <tr>
                                <th>Domingo</th>
                                <th>Segunda</th>
                                <th>Terça</th>
                                <th>Quarta</th>
                                <th>Quinta</th>
                                <th>Sexta</th>
                                <th>Sábado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set dia_semana_primeiro = primeiro_dia.weekday() %}
                            {% set dia_semana_primeiro = (dia_semana_primeiro + 1) % 7 %}  <!-- Ajuste para domingo = 0 -->
                            {% set total_dias = ultimo_dia.day %}
                            
                            <!-- Primeira linha - dias do mês anterior e primeiros dias do mês atual -->
                            <tr>
                                {% for i in range(7) %}
                                    {% if i < dia_semana_primeiro %}
                                        {% set dia_anterior = primeiro_dia - timedelta(days=(dia_semana_primeiro - i)) %}
                                        <td class="dia-outro-mes">{{ dia_anterior.day }}</td>
                                    {% else %}
                                        {% set dia_atual = i - dia_semana_primeiro + 1 %}
                                        {% set data_atual = date(ano_atual, mes_atual, dia_atual) %}
                                        <td class="{% if data_atual == hoje %}hoje{% endif %} {% if data_atual.weekday() >= 5 %}fim-de-semana{% endif %} {% if data_atual in feriados_datas %}feriado{% endif %}">
                                            <div class="numero-dia">{{ dia_atual }}</div>
                                            
                                            {% if data_atual in registros %}
                                                {% set registro = registros[data_atual] %}
                                                
                                                {% if registro.afastamento %}
                                                    {% set tipo_classe = "" %}
                                                    {% set tipo_texto = "Afastamento" %}
                                                    {% set tipo_icone = "user-clock" %}
                                                    
                                                    {% if registro.tipo_afastamento == "ferias" %}
                                                        {% set tipo_classe = "ferias-badge" %}
                                                        {% set tipo_texto = "Férias" %}
                                                        {% set tipo_icone = "umbrella-beach" %}
                                                    {% elif registro.tipo_afastamento == "licenca_medica" %}
                                                        {% set tipo_classe = "licenca-badge" %}
                                                        {% set tipo_texto = "Licença Médica" %}
                                                        {% set tipo_icone = "procedures" %}
                                                    {% elif registro.tipo_afastamento == "licenca_maternidade" %}
                                                        {% set tipo_classe = "licenca-badge" %}
                                                        {% set tipo_texto = "Licença Maternidade" %}
                                                        {% set tipo_icone = "baby" %}
                                                    {% elif registro.tipo_afastamento == "abono" %}
                                                        {% set tipo_classe = "abono-badge" %}
                                                        {% set tipo_texto = "Abono" %}
                                                        {% set tipo_icone = "calendar-check" %}
                                                    {% endif %}
                                                    
                                                    <div class="afastamento-badge {{ tipo_classe }}">
                                                        <i class="fas fa-{{ tipo_icone }} me-1"></i> {{ tipo_texto }}
                                                    </div>
                                                {% elif registro.horas_trabalhadas %}
                                                    <div class="registro-completo">
                                                        <div class="horarios">
                                                            {% if registro.entrada %}
                                                                <span class="entrada"><i class="fas fa-sign-in-alt text-success"></i> {{ registro.entrada.strftime('%H:%M') }}</span>
                                                            {% endif %}
                                                            
                                                            {% if registro.saida %}
                                                                <span class="saida"><i class="fas fa-sign-out-alt text-danger"></i> {{ registro.saida.strftime('%H:%M') }}</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="horas-badge {% if registro.horas_trabalhadas >= 8 %}horas-completas{% else %}horas-parciais{% endif %}">
                                                            <i class="fas fa-clock me-1"></i> {{ "%.1f"|format(registro.horas_trabalhadas) }}h
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="sem-registro-badge">
                                                        Sem registro
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="acoes-dia">
                                                    <a href="{{ url_for('main.visualizar_ponto', ponto_id=registro.id) }}" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                            {% elif data_atual.weekday() < 5 and data_atual not in feriados_datas and data_atual <= hoje %}
                                                <div class="sem-registro-badge">
                                                    Sem registro
                                                </div>
                                                
                                                {% if current_user.id == usuario.id %}
                                                <div class="acoes-dia">
                                                    <a href="{{ url_for('main.registrar_multiplo_ponto') }}?data={{ data_atual.strftime('%Y-%m-%d') }}" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-plus"></i>
                                                    </a>
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                            
                                            {% if data_atual in feriados_datas %}
                                                <div class="feriado-badge">
                                                    <i class="fas fa-star me-1"></i> Feriado: {{ feriados_dict.get(data_atual, 'Feriado') }}
                                                </div>
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                            
                            <!-- Calcula quantos dias já foram mostrados -->
                            {% set dias_mostrados = 7 - dia_semana_primeiro %}
                            
                            <!-- Calcula quantas semanas adicionais são necessárias -->
                            {% set semanas_adicionais = ((total_dias - dias_mostrados) // 7) + (1 if (total_dias - dias_mostrados) % 7 > 0 else 0) %}
                            
                            <!-- Gera as linhas adicionais do calendário -->
                            {% for semana in range(semanas_adicionais) %}
                                <tr>
                                    {% for dia_semana in range(7) %}
                                        {% set dia_atual = dias_mostrados + dia_semana + 1 + (semana * 7) %}
                                        {% if dia_atual <= total_dias %}
                                            {% set data_atual = date(ano_atual, mes_atual, dia_atual) %}
                                            <td class="{% if data_atual == hoje %}hoje{% endif %} {% if data_atual.weekday() >= 5 %}fim-de-semana{% endif %} {% if data_atual in feriados_datas %}feriado{% endif %}">
                                                <div class="numero-dia">{{ dia_atual }}</div>
                                                
                                                {% if data_atual in registros %}
                                                    {% set registro = registros[data_atual] %}
                                                    
                                                    {% if registro.afastamento %}
                                                        {% set tipo_classe = "" %}
                                                        {% set tipo_texto = "Afastamento" %}
                                                        {% set tipo_icone = "user-clock" %}
                                                        
                                                        {% if registro.tipo_afastamento == "ferias" %}
                                                            {% set tipo_classe = "ferias-badge" %}
                                                            {% set tipo_texto = "Férias" %}
                                                            {% set tipo_icone = "umbrella-beach" %}
                                                        {% elif registro.tipo_afastamento == "licenca_medica" %}
                                                            {% set tipo_classe = "licenca-badge" %}
                                                            {% set tipo_texto = "Licença Médica" %}
                                                            {% set tipo_icone = "procedures" %}
                                                        {% elif registro.tipo_afastamento == "licenca_maternidade" %}
                                                            {% set tipo_classe = "licenca-badge" %}
                                                            {% set tipo_texto = "Licença Maternidade" %}
                                                            {% set tipo_icone = "baby" %}
                                                        {% elif registro.tipo_afastamento == "abono" %}
                                                            {% set tipo_classe = "abono-badge" %}
                                                            {% set tipo_texto = "Abono" %}
                                                            {% set tipo_icone = "calendar-check" %}
                                                        {% endif %}
                                                        
                                                        <div class="afastamento-badge {{ tipo_classe }}">
                                                            <i class="fas fa-{{ tipo_icone }} me-1"></i> {{ tipo_texto }}
                                                        </div>
                                                    {% elif registro.horas_trabalhadas %}
                                                        <div class="registro-completo">
                                                            <div class="horarios">
                                                                {% if registro.entrada %}
                                                                    <span class="entrada"><i class="fas fa-sign-in-alt text-success"></i> {{ registro.entrada.strftime('%H:%M') }}</span>
                                                                {% endif %}
                                                                
                                                                {% if registro.saida %}
                                                                    <span class="saida"><i class="fas fa-sign-out-alt text-danger"></i> {{ registro.saida.strftime('%H:%M') }}</span>
                                                                {% endif %}
                                                            </div>
                                                            <div class="horas-badge {% if registro.horas_trabalhadas >= 8 %}horas-completas{% else %}horas-parciais{% endif %}">
                                                                <i class="fas fa-clock me-1"></i> {{ "%.1f"|format(registro.horas_trabalhadas) }}h
                                                            </div>
                                                        </div>
                                                    {% else %}
                                                        <div class="sem-registro-badge">
                                                            Sem registro
                                                        </div>
                                                    {% endif %}
                                                    
                                                    <div class="acoes-dia">
                                                        <a href="{{ url_for('main.visualizar_ponto', ponto_id=registro.id) }}" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    </div>
                                                {% elif data_atual.weekday() < 5 and data_atual not in feriados_datas and data_atual <= hoje %}
                                                    <div class="sem-registro-badge">
                                                        Sem registro
                                                    </div>
                                                    
                                                    {% if current_user.id == usuario.id %}
                                                    <div class="acoes-dia">
                                                        <a href="{{ url_for('main.registrar_multiplo_ponto') }}?data={{ data_atual.strftime('%Y-%m-%d') }}" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-plus"></i>
                                                        </a>
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                                
                                                {% if data_atual in feriados_datas %}
                                                    <div class="feriado-badge">
                                                        <i class="fas fa-star me-1"></i> Feriado: {{ feriados_dict.get(data_atual, 'Feriado') }}
                                                    </div>
                                                {% endif %}
                                            </td>
                                        {% else %}
                                            {% set dia_proximo = ultimo_dia + timedelta(days=(dia_atual - total_dias)) %}
                                            <td class="dia-outro-mes">{{ dia_proximo.day }}</td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Registros do Mês</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Dias Úteis</h6>
                                <h3 class="card-title">{{ dias_uteis }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Dias Trabalhados</h6>
                                <h3 class="card-title">{{ dias_trabalhados }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Dias de Afastamento</h6>
                                <h3 class="card-title">{{ dias_afastamento }}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Dias Pendentes</h6>
                                <h3 class="card-title">{{ dias_uteis - dias_trabalhados - dias_afastamento }}</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Horas Trabalhadas</h6>
                                <h3 class="card-title">{{ "%.1f"|format(horas_trabalhadas) }}h</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Carga Horária Devida</h6>
                                <h3 class="card-title">{{ "%.1f"|format(carga_horaria_devida) }}h</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Saldo de Horas</h6>
                                <h3 class="card-title {% if saldo_horas >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "%.1f"|format(saldo_horas) }}h
                                </h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Entrada</th>
                                <th>Saída Almoço</th>
                                <th>Retorno Almoço</th>
                                <th>Saída</th>
                                <th>Horas</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registro in registros.values()|sort(attribute='data') %}
                            <tr>
                                <td>{{ registro.data.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    {% if registro.afastamento %}
                                        {% if registro.tipo_afastamento == "ferias" %}
                                            <span class="badge bg-info">Férias</span>
                                        {% elif registro.tipo_afastamento == "licenca_medica" %}
                                            <span class="badge bg-warning">Licença Médica</span>
                                        {% elif registro.tipo_afastamento == "licenca_maternidade" %}
                                            <span class="badge bg-warning">Licença Maternidade</span>
                                        {% elif registro.tipo_afastamento == "abono" %}
                                            <span class="badge bg-info">Abono</span>
                                        {% else %}
                                            <span class="badge bg-info">Afastamento</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-success">Trabalho</span>
                                    {% endif %}
                                </td>
                                <td>{{ registro.entrada.strftime('%H:%M') if registro.entrada else '--:--' }}</td>
                                <td>{{ registro.saida_almoco.strftime('%H:%M') if registro.saida_almoco else '--:--' }}</td>
                                <td>{{ registro.retorno_almoco.strftime('%H:%M') if registro.retorno_almoco else '--:--' }}</td>
                                <td>{{ registro.saida.strftime('%H:%M') if registro.saida else '--:--' }}</td>
                                <td>
                                    {% if registro.afastamento %}
                                        --
                                    {% else %}
                                        {{ "%.1f"|format(registro.horas_trabalhadas) if registro.horas_trabalhadas else '0.0' }}
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('main.visualizar_ponto', ponto_id=registro.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center">Nenhum registro encontrado para este mês</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const usuarioSelect = document.getElementById('usuario-select');
        const btnVisualizar = document.getElementById('btn-visualizar');
        
        if (btnVisualizar) {
            btnVisualizar.addEventListener('click', function() {
                const userId = usuarioSelect.value;
                window.location.href = "{{ url_for('main.calendario') }}?user_id=" + userId;
            });
        }
    });
</script>
{% endblock %}
